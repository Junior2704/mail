<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>√âditeur avanc√© de mod√®les d‚Äôe-mails</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f9;
  margin: 0;
  padding: 20px;
}
h1 { color: #0057a4; }
#container { display: flex; gap: 4%; }
#editor, #preview {
  width: 48%;
  height: 500px;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  font-family: monospace;
}
#editor { resize: vertical; }
input, button, select, textarea {
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
button {
  background: #0057a4;
  color: white;
  border: none;
  cursor: pointer;
}
button:hover { background: #004080; }
</style>
</head>
<body>
<h1>üß© Gestion des mod√®les d‚Äôe-mails avec variables</h1>

<div>
  <label for="modelSelect">S√©lectionner un mod√®le :</label>
  <select id="modelSelect">
    <option value="">-- Nouveau mod√®le --</option>
  </select>
  <button onclick="supprimerModele()">üóëÔ∏è Supprimer le mod√®le</button>
</div>

<div id="container">
  <textarea id="editor" placeholder="√âcris ton mod√®le HTML ici..."></textarea>
  <iframe id="preview"></iframe>
</div>

<br>
<input type="text" id="templateName" placeholder="Nom du mod√®le (ex: compte_rendu)">
<input type="text" id="subject" placeholder="Sujet de l‚Äôe-mail">
<textarea id="variablesInput" placeholder='Variables JSON, ex: {"patient_nom":"Dupont","lien":"https://lien.com"}'></textarea>
<br>
<button onclick="enregistrerModele()">üíæ Enregistrer</button>
<button onclick="envoyerTest()">‚úâÔ∏è Envoyer un test</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// üîπ Config Firebase √† remplacer par tes infos
const firebaseConfig = {
  apiKey: "TA_CLE",
  authDomain: "TON_PROJET.firebaseapp.com",
  projectId: "TON_PROJET",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// üîπ Pr√©visualisation
const editor = document.getElementById("editor");
const preview = document.getElementById("preview").contentDocument;
editor.addEventListener("input", () => {
  preview.open();
  preview.write(editor.value);
  preview.close();
});

// üîπ Mod√®les
const modelSelect = document.getElementById("modelSelect");
let currentModel = "";

async function chargerModeles() {
  modelSelect.innerHTML = '<option value="">-- Nouveau mod√®le --</option>';
  const snapshot = await getDocs(collection(db, "email_templates"));
  snapshot.forEach(docSnap => {
    const name = docSnap.id;
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    modelSelect.appendChild(option);
  });
}
chargerModeles();

modelSelect.addEventListener("change", async () => {
  const name = modelSelect.value;
  currentModel = name;
  if (!name) {
    editor.value = "";
    document.getElementById("templateName").value = "";
    document.getElementById("subject").value = "";
    document.getElementById("variablesInput").value = "";
    preview.open();
    preview.write("");
    preview.close();
    return;
  }
  const docSnap = await getDoc(doc(db, "email_templates", name));
  if (!docSnap.exists()) return alert("Mod√®le introuvable !");
  const data = docSnap.data();
  editor.value = data.html;
  document.getElementById("templateName").value = name;
  document.getElementById("subject").value = data.subject;
  document.getElementById("variablesInput").value = JSON.stringify(data.defaultVariables || {}, null, 2);
  preview.open();
  preview.write(editor.value);
  preview.close();
});

// üîπ Enregistrer mod√®le
async function enregistrerModele() {
  const name = document.getElementById("templateName").value.trim();
  const subject = document.getElementById("subject").value.trim();
  const variablesText = document.getElementById("variablesInput").value.trim();
  if (!name || !subject || !editor.value.trim()) return alert("Remplis tous les champs !");
  let defaultVariables = {};
  try { defaultVariables = variablesText ? JSON.parse(variablesText) : {}; } catch(e) { return alert("Variables JSON invalides !"); }
  await setDoc(doc(db, "email_templates", name), {
    html: editor.value,
    subject: subject,
    defaultVariables: defaultVariables
  });
  alert("Mod√®le enregistr√© !");
  chargerModeles();
}

// üîπ Supprimer mod√®le
async function supprimerModele() {
  const name = modelSelect.value;
  if (!name) return alert("S√©lectionne un mod√®le √† supprimer !");
  if (!confirm(`Supprimer le mod√®le "${name}" ?`)) return;
  await deleteDoc(doc(db, "email_templates", name));
  alert("Mod√®le supprim√© !");
  chargerModeles();
  editor.value = "";
  document.getElementById("templateName").value = "";
  document.getElementById("subject").value = "";
  document.getElementById("variablesInput").value = "";
  preview.open();
  preview.write("");
  preview.close();
}

// üîπ Remplacer les variables dans le HTML
function remplacerVariables(html, variables) {
  return html.replace(/\{\{(.*?)\}\}/g, (_, key) => variables[key.trim()] || '');
}

// üîπ Envoyer un test
async function envoyerTest() {
  const templateName = document.getElementById("templateName").value.trim();
  const to = prompt("Adresse e-mail de test ?");
  if (!templateName || !to) return alert("Nom du mod√®le et e-mail obligatoires !");
  
  const docSnap = await getDoc(doc(db, "email_templates", templateName));
  if (!docSnap.exists()) return alert("Mod√®le introuvable !");
  const data = docSnap.data();

  // Variables sp√©cifiques pour cet envoi
  let variables = {};
  try { variables = document.getElementById("variablesInput").value ? JSON.parse(document.getElementById("variablesInput").value) : {}; } catch(e) { return alert("Variables JSON invalides !"); }

  try {
    const res = await fetch("https://mail-api.onrender.com/send-email", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        key: "MA_SUPER_CLE_SECRETE",
        template: templateName,
        to: to,
        variables: variables
      })
    });
    const result = await res.json();
    alert(JSON.stringify(result));
  } catch (err) {
    alert("Erreur : " + err.message);
  }
}
</script>
</body>
</html>
