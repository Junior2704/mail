<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>√âditeur de mod√®les d‚Äôe-mail</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f9;
  margin: 0;
  padding: 20px;
}
h1 { color: #0057a4; }
#container {
  display: flex;
  gap: 4%;
}
#editor, #preview {
  width: 48%;
  height: 500px;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  font-family: monospace;
}
#editor { resize: vertical; }
input, button {
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
button {
  background: #0057a4;
  color: white;
  border: none;
  cursor: pointer;
}
button:hover { background: #004080; }
</style>
</head>
<body>
<h1>üß© Gestion des mod√®les d‚Äôe-mails</h1>

<div id="container">
  <textarea id="editor" placeholder="√âcris ton mod√®le HTML ici..."></textarea>
  <iframe id="preview"></iframe>
</div>

<br>
<input type="text" id="templateName" placeholder="Nom du mod√®le (ex: compte_rendu)">
<input type="text" id="subject" placeholder="Sujet de l‚Äôe-mail">
<br>
<button onclick="enregistrerModele()">üíæ Enregistrer</button>
<button onclick="envoyerTest()">‚úâÔ∏è Envoyer un test</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// üîπ Config Firebase √† remplacer par tes infos
const firebaseConfig = {
  apiKey: "TA_CLE",
  authDomain: "TON_PROJET.firebaseapp.com",
  projectId: "TON_PROJET",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// üîπ Pr√©visualisation en direct
const editor = document.getElementById("editor");
const preview = document.getElementById("preview").contentDocument;

editor.addEventListener("input", () => {
  preview.open();
  preview.write(editor.value);
  preview.close();
});

// üîπ Enregistrer un mod√®le dans Firestore
async function enregistrerModele() {
  const name = document.getElementById("templateName").value.trim();
  const subject = document.getElementById("subject").value.trim();
  if (!name || !subject || !editor.value.trim()) {
    alert("Remplis tous les champs !");
    return;
  }
  await setDoc(doc(db, "email_templates", name), {
    html: editor.value,
    subject: subject
  });
  alert("Mod√®le enregistr√© !");
}

// üîπ Envoyer un test via ton API Render
async function envoyerTest() {
  const templateName = document.getElementById("templateName").value.trim();
  const subject = document.getElementById("subject").value.trim();
  const to = prompt("Adresse e-mail de test ?");
  if (!templateName || !to) return alert("Nom du mod√®le et e-mail obligatoires !");
  
  // R√©cup√©rer le template depuis Firestore
  const docSnap = await getDoc(doc(db, "email_templates", templateName));
  if (!docSnap.exists()) return alert("Mod√®le introuvable !");
  const data = docSnap.data();
  const html = data.html;
  
  // Variables de test √† remplacer
  const variables = {
    patient_nom: "Dupont",
    patient_prenom: "Marie",
    lien_compte_rendu: "https://mon-lien.com/doc123"
  };
  
  try {
    const res = await fetch("https://mail-api.onrender.com/send-email", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        key: "MA_SUPER_CLE_SECRETE",
        template: templateName,
        to: to,
        variables: variables
      })
    });
    const result = await res.json();
    alert(JSON.stringify(result));
  } catch (err) {
    alert("Erreur : " + err.message);
  }
}
</script>
</body>
</html>
